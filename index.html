<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BHOP / KZ Records</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;background:#0b0e12;color:#e5e7eb}
  header{padding:16px 20px;background:#111827;position:sticky;top:0}
  h1{margin:0;font-size:18px}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  input,select{background:#0f172a;border:1px solid #334155;color:#e5e7eb;padding:8px;border-radius:8px}
  table{width:100%;border-collapse:collapse;background:#0f172a;border:1px solid #1f2937;border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid #1f2937;font-size:14px}
  th{background:#111827;text-align:left;cursor:pointer;user-select:none}
  tr:hover td{background:#111827}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid #334155;font-size:12px}
  .muted{color:#9ca3af}
  footer{opacity:.7;font-size:12px;margin:16px 0}
</style>
</head>
<body>
<header><h1>BHOP / KZ Records</h1></header>
<div class="wrap">
  <div class="controls">
    <input id="q" type="search" placeholder="Buscar por mapa o jugador…" />
    <select id="filterPrefix">
      <option value="">Todo</option>
      <option value="bh_">bh_</option>
      <option value="hb_">hb_</option>
      <option value="kzarg_">kzarg_</option>
    </select>
    <select id="limit">
      <option value="25">Top 25</option>
      <option value="50">Top 50</option>
      <option value="100">Top 100</option>
      <option value="0">Sin límite</option>
    </select>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th data-k="rank">#</th>
        <th data-k="map">Mapa</th>
        <th data-k="player">Jugador</th>
        <th data-k="time">Tiempo</th>
        <th data-k="date">Fecha</th>
        <th data-k="steamid">SteamID</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="6" class="muted">Cargando…</td></tr></tbody>
  </table>

  <footer>Funciona en MOTD usando esta URL. Actualiza <code>records.json</code> para refrescar.</footer>
</div>

<script>
const STATE = { data: [], sortKey: "rank", sortDir: 1 };

const elTbody = document.querySelector("#tbl tbody");
const elQ = document.querySelector("#q");
const elPrefix = document.querySelector("#filterPrefix");
const elLimit = document.querySelector("#limit");

const JSON_URL = "records.json";

function cmp(a,b,key,dir){
  const va = a[key] ?? "", vb = b[key] ?? "";
  if (key === "rank") return (Number(va)-Number(vb))*dir;
  if (key === "time") return String(va).localeCompare(String(vb)) * dir;
  return String(va).localeCompare(String(vb), "es", {numeric:true,sensitivity:"base"}) * dir;
}

function render(){
  const q = elQ.value.trim().toLowerCase();
  const pref = elPrefix.value;
  const lim = Number(elLimit.value);

  let rows = STATE.data.slice();

  if (q){
    rows = rows.filter(r =>
      String(r.map).toLowerCase().includes(q) ||
      String(r.player).toLowerCase().includes(q)
    );
  }
  if (pref){
    rows = rows.filter(r => String(r.map).toLowerCase().startsWith(pref));
  }

  rows.sort((a,b)=>cmp(a,b,STATE.sortKey,STATE.sortDir));
  if (lim > 0) rows = rows.slice(0, lim);

  if (!rows.length){
    elTbody.innerHTML = `<tr><td colspan="6" class="muted">Sin resultados.</td></tr>`;
    return;
  }

  elTbody.innerHTML = rows.map(r => `
    <tr>
      <td><span class="pill">#${r.rank ?? ""}</span></td>
      <td>${esc(r.map)}</td>
      <td>${esc(r.player)}</td>
      <td>${esc(r.time)}</td>
      <td class="muted">${esc(r.date ?? "")}</td>
      <td class="muted">${esc(r.steamid ?? "")}</td>
    </tr>
  `).join("");
}

function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

async function boot(){
  try{
    const res = await fetch(JSON_URL, {cache:"no-store"});
    const data = await res.json();
    STATE.data = Array.isArray(data) ? data : [];
  }catch(e){
    STATE.data = [];
  }
  render();
}

document.querySelectorAll("th[data-k]").forEach(th=>{
  th.addEventListener("click", ()=>{
    const k = th.dataset.k;
    if (STATE.sortKey === k) STATE.sortDir *= -1;
    else { STATE.sortKey = k; STATE.sortDir = 1; }
    render();
  });
});
elQ.addEventListener("input", render);
elPrefix.addEventListener("change", render);
elLimit.addEventListener("change", render);

boot();
</script>
</body>
</html>
